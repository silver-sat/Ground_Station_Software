{% extends 'base.html' %}

{% block header %}
<h1>{% block title %}Ground Control{% endblock %}</h1>
{% endblock %}

{% block content %}
<form method="POST">
    <h2>Enter Command</h2>
    <input type="text" name="command" id="command" placeholder="Type Command Here...">
    <input type="submit" value="Transmit">
    <h2>Quick Actions</h2>
    <table>
        <tbody>
            <tr>
                <td><button type="submit" name="clicked_button" value="NOP">No operation</button></td>
                <td><button type="submit" name="clicked_button" value="STP">Send test packet</button></td>
            </tr>
            <tr>
                <td><button type="submit" name="clicked_button" value="SRC">Set clock to GMT</button></td>
                <td><button type="submit" name="clicked_button" value="GRC">Get clock time</button></td>
            </tr>
            <tr>
                <td><button type="submit" name="clicked_button" value="PYC">Payload communications</button></td>
                <td><button type="submit" name="clicked_button" value="SPT1">Take photo in one minute</button></td>
            </tr>
            <tr>
                <td><button type="submit" name="clicked_button" value="SBI1">Set beacon interval to one minute</button>
                <td><button type="submit" name="clicked_button" value="SBI3">Set beacon interval to three
                        minutes</button></td>
            </tr>
            <tr>
                <td><button type="submit" name="clicked_button" value="GTY">Get telemetry</button></td>
                <td><button type="submit" name="clicked_button" value="GPW">Get power</button></td>
            </tr>
            <tr>
                <td><button type="submit" name="clicked_button" value="CallSign">Transmit call sign</button></td>
                <td><button type="submit" name="clicked_button" value="Refresh">Refresh data</button></td>
            </tr>
        </tbody>
    </table>
    <h2>Received from Satellite</h2>
    <div class="responses" id="responses">
        {% for response in responses %}
        <p>{{ response['timestamp'] + " - " + response['response'].decode('utf-8', errors='replace').slice(2,-1) }}</p>
        {% endfor %}
    </div>
</form>
<script>
    function fetchLatestResponses() {
        fetch('/latest_responses')
            .then(response => response.json())
            .then(data => {
                const responsesDiv = document.getElementById('responses');
                responsesDiv.innerHTML = '';
                const filteredData = data.filter(item => {
                    const trimResponse = item.response.slice(2, -1);
                    return !trimResponse.startsWith("ACK D") && !trimResponse.startsWith("RES D");
                });
                filteredData.forEach(item => {
                    const p = document.createElement('p');
                    p.textContent = item.timestamp + " - " + item.response;
                    responsesDiv.appendChild(p);
                });
            });
    }

    setInterval(fetchLatestResponses, 1000); // Fetch latest responses every second
</script>
{% endblock %}